# """
# yookassa_webhook_handler.py
# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–µ–±—Ö—É–∫–æ–≤ –æ—Ç YooKassa
# """

# import logging
# import json
# import sqlite3
# from aiohttp import web
# from yookassa.domain.notification import WebhookNotification

# async def handle_yookassa_webhook(request):
#     """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–µ–±—Ö—É–∫–æ–≤ –æ—Ç YooKassa"""
#     try:
#         # –ü–æ–ª—É—á–∞–µ–º JSON –¥–∞–Ω–Ω—ã–µ
#         body = await request.text()
#         data = json.loads(body)
        
#         logging.info(f"üì® –ü–æ–ª—É—á–µ–Ω –≤–µ–±—Ö—É–∫ –æ—Ç YooKassa: {data}")
        
#         # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
#         notification = WebhookNotification(data)
        
#         # –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç –ø–ª–∞—Ç–µ–∂–∞
#         payment = notification.object
        
#         # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ
#         if notification.event == 'payment.succeeded':
#             await handle_successful_payment(payment)
#         elif notification.event == 'payment.canceled':
#             await handle_canceled_payment(payment)
#         elif notification.event == 'payment.waiting_for_capture':
#             await handle_pending_payment(payment)
        
#         # –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 200 OK
#         return web.json_response({"status": "success"})
        
#     except Exception as e:
#         logging.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–µ–±—Ö—É–∫–∞ YooKassa: {e}")
#         return web.json_response({"status": "error"}, status=500)

# async def handle_successful_payment(payment):
#     """–û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞"""
#     try:
#         metadata = payment.metadata or {}
#         payment_id = metadata.get('payment_id')
#         user_id = metadata.get('user_id')
#         amount = payment.amount.value if payment.amount else 0
        
#         if not payment_id:
#             logging.error("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω payment_id –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–∞")
#             return
        
#         logging.info(f"‚úÖ –£—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂! Payment ID: {payment_id}, –°—É–º–º–∞: {amount}")
        
#         # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
#         conn = sqlite3.connect('subscription_bot.db')
#         cursor = conn.cursor()
        
#         cursor.execute('''
#             UPDATE payments 
#             SET status = 'completed', 
#                 yoomoney_operation_id = ?,
#                 completed_at = datetime('now')
#             WHERE id = ?
#         ''', (payment.id, payment_id))
        
#         # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–ª–∞—Ç–µ–∂–µ
#         cursor.execute('''
#             SELECT user_id, bots_count FROM payments WHERE id = ?
#         ''', (payment_id,))
        
#         result = cursor.fetchone()
#         if result:
#             user_id, bots_count = result
            
#             # –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
#             cursor.execute('''
#                 INSERT OR REPLACE INTO user_bots (user_id, available_bots, total_bots)
#                 VALUES (?, 
#                     COALESCE((SELECT available_bots FROM user_bots WHERE user_id = ?), 0) + ?,
#                     COALESCE((SELECT total_bots FROM user_bots WHERE user_id = ?), 0) + ?
#                 )
#             ''', (user_id, user_id, bots_count, user_id, bots_count))
            
#             conn.commit()
#             logging.info(f"üí∞ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –ø–æ–ª—É—á–∏–ª {bots_count} –±–æ—Ç–æ–≤")
            
#             # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
#             await send_telegram_notification(user_id, bots_count, amount)
        
#         conn.close()
        
#     except Exception as e:
#         logging.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞: {e}")

# async def handle_canceled_payment(payment):
#     """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞"""
#     try:
#         metadata = payment.metadata or {}
#         payment_id = metadata.get('payment_id')
        
#         if payment_id:
#             conn = sqlite3.connect('subscription_bot.db')
#             cursor = conn.cursor()
            
#             cursor.execute('''
#                 UPDATE payments SET status = 'canceled' WHERE id = ?
#             ''', (payment_id,))
            
#             conn.commit()
#             conn.close()
            
#             logging.info(f"‚ùå –ü–ª–∞—Ç–µ–∂ –æ—Ç–º–µ–Ω–µ–Ω: {payment_id}")
            
#     except Exception as e:
#         logging.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–º–µ–Ω–µ–Ω–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞: {e}")

# async def handle_pending_payment(payment):
#     """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–∂–∏–¥–∞—é—â–µ–≥–æ –ø–ª–∞—Ç–µ–∂–∞"""
#     logging.info(f"‚è≥ –ü–ª–∞—Ç–µ–∂ –æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: {payment.id}")

# async def send_telegram_notification(user_id: int, bots_count: int, amount: float):
#     """–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram"""
#     # –ó–¥–µ—Å—å –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —á–µ—Ä–µ–∑ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞
#     logging.info(f"üì¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è {user_id}: –æ–ø–ª–∞—á–µ–Ω–æ {bots_count} –±–æ—Ç–æ–≤ –Ω–∞ —Å—É–º–º—É {amount} —Ä—É–±")
